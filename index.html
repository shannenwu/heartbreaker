<!DOCTYPE html>
<html lang="en">



<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Beats</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom fonts for this template -->
  <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i" rel="stylesheet">
  <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="vendor/devicons/css/devicons.min.css" rel="stylesheet">
  <link href="vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet">

  <!-- Custom styles for this template -->
  <link href="css/resume.min.css" rel="stylesheet">
  <link rel="icon" href="img/favicon.ico">

</head>

<body id="page-top">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
    <a class="navbar-brand js-scroll-trigger" href="#page-top">
      <span class="d-block d-lg-none">
        FLEX YOUR HEART
        <!-- <img class="img-fluid" src="img/hbg.jpg" alt=""> -->
      </span>
      <span class="d-none d-lg-block">
        <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="img/heart.jpg" alt="">
      </span>
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#about">Overview</a>
        </li>
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#experience">Overall Design</a>
        </li>
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#education">System Design</a>
        </li>
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#skills">Documentation</a>
        </li>
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#interests">Team 17</a>
        </li>
        <li class="nav-item">
          <a class="nav-link js-scroll-trigger" href="#awards">Conclusion and Future Work</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container-fluid p-0">

    <section class="resume-section p-3 p-lg-5 d-flex d-column" id="about">
      <div class="my-auto">
        <h1 class="mb-0">
          <span class="text-primary">Beats</span>
        </h1>
        <div class="subheading mb-5"> A new kind of rhythm
        </div>
        <p class="mb-5"> <a href = "https://youtu.be/WekyjXIR7fY" target="_blank"><i>Beats</i></a> is a running pal that aids in understanding the efficiency and intensity of your running. View your real-time BPM, step count, and steps per minute during your run! After you’re done, head over to our website to see analytics and visualizations, including graphs of your <a href = "http://iesc-s1.mit.edu/608dev/sandbox/doryshen/heartRate/heartRate.py?type=ekg" target="_blank"> BPM</a> and <a href = "http://iesc-s1.mit.edu/608dev/sandbox/doryshen/heartRate/heartRate.py?type=steps" target="_blank"> steps</a> across your workout. 
        </p>
      </div>
    </section>

    <section class="resume-section p-3 p-lg-5 d-flex flex-column" id="experience">
      <div class="my-auto">
        <h2 class="mb-5">Overall Design</h2>

        <div class="resume-item d-flex flex-column flex-md-row mb-5">
          <div class="resume-content mr-auto">
            <h3 class="mb-0">Design Decisions and Rationale</h3>
            <div class="subheading mb-3">OLED TOGGLE
              <ul>
                <li><p class = "bullet">The user is able to access their fitness data during their run, which is done by displaying the information/graphs on the OLED.</p>
                </li>
                <li><p class = "bullet">Since the heart rate and pace/distance are both important pieces of information, we decided to show the user both of these by toggling between two screens. One displays total steps and steps/min, the other displays current heart rate and a graph of the user’s BPM over the last 2 minutes so they can see the trend. </p>
                </li>
              </ul>
            </div>
            <div class="subheading mb-3">PLOTTING HEART RATE
              <ul>
                <li><p class = "bullet">Once we collected the signal from the pulse sensor and calculated the BPM, we had to decide what exactly to plot. Initially we had envisioned a typical EKG graph plotting each pulse. Then we realised that someone using the device while running would not be able to glean much from that kind of graph. It would be better to see it in terms of BPM, and the trend in BPM over the past few minutes. 
                </p>
              </li>
            </ul>
          </div>
          <div class="subheading mb-3">SERVER SIDE GRAPHS
            <ul>
              <li><p class = "bullet">Once a runner finishes their run, it’s extremely useful to look at the consolidated steps/min and heart rate data across the entire run to identify trends. This is done by sending the data to the server at the end of each run and displaying heart rate by time and steps/min by time graphs for the user to see on the server. This seems pretty useful to visualise information from the run and compare different points in the run. 
              </p>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <div class="resume-item d-flex flex-column flex-md-row mb-5">
      <div class="resume-content mr-auto">
        <h3 class="mb-0">Challenges</h3>
        <div class="subheading mb-3">FINGER-CLIP HEART RATE SENSOR
          <ul>
            <li><p class = "bullet">One of the biggest challenges with the finger rate sensor was positioning it in a consistent location with each sampling. In order to overcome this challenge, we had to utilize velcro to place the sensor on the center of the user’s finger. Consistency was particularly important during the run, as if the position of the sensor on the user’s finger changed while they were running, then the average of the readings would also be impacted and therefore change the threshold at which the signal must be in order to be detected as a pulse.</p>
            </li>
            <li><p class = "bullet">Another big challenge with the finger rate sensor was filtering out noise. Since the sensor detects light, exposure to external light would cause the signal to be higher. Therefore, we created a cloth covering that we attached to the velcro that kept the sensor in place. This ensured that little light reached the pulse sensor, therefore preventing added noise.</p>
            </li>
            <li><p class = "bullet">The pin for the EKG broke off from the wire during one of the initial weeks of working on the project. This made it difficult to insert it into the breadboard since the wire tip was frayed. We soldered the end of the wire back to fix this.</p>
            </li>
          </ul>
        </div>
        <div class="subheading mb-3">PULSE DETECTION 
          <ul>
            <li><p class = "bullet">In order to detect pulses, we needed to find a threshold at which, if the signal was higher than this given threshold, we would indicate that we had detected a pulse. It was difficult to find this threshold as the sensitivity of the sensor meant that the raw readings varied in magnitude. We tested out a few different values for the threshold and decided on 1.3*average.
            </p>
          </li>
          <li><p class = "bullet">In order to deal with the variance in magnitude of the readings, we decided to use an averaging filter over the last minute of data.
          </p>
          <li><p class = "bullet">Averaging filter for raw data:
            <ul>
              <li><p class = "bullet"> We had to figure out how long to collect an average over past data. Since it took a while to get an accurate threshold, we needed to test different time periods and found that after about the first minute, the readings evened out.</p>
              </li>
              <li><p class = "bullet"> Hence our average, and hence the threshold we calculate, would be adjusted if the user’s heart rate went up while running so we could measure the correct number of pulses.</p>
              </li>
            </ul>
          </p>
        </li>
        <li><p class = "bullet">Calculate BPM:
          <ul>
            <li><p class = "bullet"> This could be done by counting the number of pulses recorded in a minute, but we wanted to update faster. First we just multiplied the pulses counted in 10 seconds by 6.</p>
            </li>
            <li><p class = "bullet"> We wanted a more accurate reading and quick update so we used an averaging filter. We store number of pulses detected in 5 second intervals for last 6 “5 second intervals”. </p>
            </li>
            <li><p class = "bullet"> Then we add the six together and multiply by 2 (30*2 = 60) to get BPM. This updates the value every 5 seconds but it also averages it across the past 30 seconds so faulty readings won’t throw the BPM measurement off too much. </p>
            </li>
          </ul>
        </p>
      </li>
    </ul>
  </div>
  <div class="subheading mb-3">DISPLAYING HEART RATE GRAPH ON OLED
    <ul>
      <li><p class = "bullet">One challenge we had with displaying the graph on the OLED is how often we could plot points onto the OLED. Originally, we wanted to continuously plot points onto the OLED. However, we soon realized that while we were plotting pixels, heart rate data was not being collected. Therefore, we had to prioritize collecting heart rate data over plotting it, and reduced the plotting rate to once every five seconds. </p>
      </li>
    </ul>
  </div>
  <div class="subheading mb-3"> IMU
    <ul>
      <li><p class = "bullet">Setting the correct threshold so we don’t overcount or undercount steps. Decided on y > 1.2 </p>
      </li>
    </ul>
  </div>
  <div class="subheading mb-3"> DISPLAYING GRAPH ON WEBSITE
    <ul>
      <li><p class = "bullet">A challenge we came across when posting from the ESP32 to display the the steps and heart rate data on was putting graphs on the website. Originally, we were going to use MatPlotLib in to generate an image and store it, and then post the saved image on the website. However, we found out that by using Bokeh Plotting the graph will display with a get request. </p>
      </li>
    </ul>
  </div>
  <div class="subheading mb-3"> INTEGRATION
    <ul>
      <li><p class = "bullet">A challenge from integrating the step counter was keeping it running in the background while the user changed between viewing steps and viewing the EKG. In order to accomplish this, a flag variable was created, and was set to 1 if a run was ongoing. At the end of every loop, the flag variable was checked, and the step counter function was run if the flag was at 1. </p>
      </li>
      <li><p class = "bullet">When testing the speech to text function in the final state machine, we decided to add a state where the user is able to confirm if the right time was processed. </p>
      </li>
    </ul>
  </div>
  <!-- <p>Dude. What was NOT challenging about this project.</p> -->
</div>
</div>

<div class="resume-item d-flex flex-column flex-md-row mb-5">
  <div class="resume-content mr-auto">
    <h3 class="mb-0">Parts List</h3>
    <ul>
      <li><p class = "bullet">Pulse Sensor <a href="https://pulsesensor.com/" target="_blank">(pulsesensor.com)</a> </p>
      </li>
      <li><p class = "bullet">Senses pulse through green-light LED.</p>
      </li>
    </ul>
  </div>
</div>
</div>

</section>

<section class="resume-section p-3 p-lg-5 d-flex flex-column" id="education">
  <div class="my-auto">
    <h2 class="mb-5">System Design</h2>

    <div class="resume-item d-flex flex-column flex-md-row mb-5">
      <div class="resume-content mr-auto">
        <h3 class="mb-0">Block Diagram</h3>
        <div class="resume-item d-flex flex-column flex-md-row">
          <img class="img-fluid mx-auto mb-2 machine" src="img/machine.png" alt="">
        </div>
        <h3 class="mb-0">State Machine Diagram</h3>
        <img class="img-fluid mx-auto mb-2 state" src="img/state.png" alt="">
      </div>
    </div>

    <div class="resume-item d-flex flex-column flex-md-row">
      <div class="resume-content mr-auto">
        <h3 class="mb-0">Energy Management</h3>
        <div class="resume-item d-flex flex-column flex-md-row">
          <img class="img-fluid mx-auto mb-2 energy" src="img/energy.jpg" alt="">
        </div>
      </div>
    </div>

  </div>
</section>

<section class="resume-section p-3 p-lg-5 d-flex flex-column" id="skills">
  <div class="my-auto">
    <h2 class="mb-5">Documentation</h2>

    <div class="resume-item d-flex flex-column flex-md-row mb-5">
      <div class="resume-content mr-auto">
        <h3 class="mb-0">How do I use <i>Beats</i>?</h3>
        <div class="subheading mb-3">Instructions</div>
        <ol type="1">
          <li>Before starting a run, press either button to begin.</li>
          <li>Hold down button to activate the microphone. Say how long you want to run for.</li>
          <li>There will be a confirmation screen asking if the time is correct. Press the left button to confirm or the right button to return to repeat the time. </li>
          <li>After confirming the time the run will start. Begin your run</li>
          <li>Click the left button to toggle between the step counter display and the heart rate display.</li>
          <li>At the end of the run (the timing period), the data will be sent to a database, so you can visit the corresponding website to see their <a href = "http://iesc-s1.mit.edu/608dev/sandbox/doryshen/heartRate/heartRate.py?type=steps" target="_blank"> steps</a> and <a href = "http://iesc-s1.mit.edu/608dev/sandbox/doryshen/heartRate/heartRate.py?type=ekg" target="_blank"> heart rate</a> graphed.</li>
        </ol>
      </div>
    </div>
    <div class="subheading mb-3">Video Instructions</div>
    <div class="embed-responsive embed-responsive-16by9">
      <iframe width="420" height="315" src="https://www.youtube.com/embed/WekyjXIR7fY" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>
  <div class="resume-item d-flex flex-column flex-md-row mb-5">
    <div class="resume-content mr-auto">
      <h3 class="mb-0">What if I want to make my own <i>Beats</i>?</h3>
      <div class="subheading mb-3">Hardware
        <ul>
          <li><p class = "bullet"> One of the major parts in our system is the pulse sensor from <a href="https://pulsesensor.com/" target="_blank">pulsesensor.com</a>, which detects pulses from the user’s finger through a green light LED. We connected the sensor to the breadboard through three wires: the red wire connects to Power, the black wire connects to Ground, the Purple Wire connects to A7 (I035 on the breadboard).</p>
          </li>
          <li><p class = "bullet">Other major components of the breadboard are the IMU, ESP32, and the microphone, all of which we wired into the board in class.</p>
          </li>
        </ul>
      </div>
      <div class="subheading mb-3">Code: Libraries
        <ul>
          <li><p class = "bullet">We didn’t use any libraries while working with the pulse sensor. </p>
          </li>
          <li><p class = "bullet">We used the U8g2lib.h library for the Oled screen, the mpu9255_esp32.h library for the IMU, and connected with the Google API for the microphone. </p>
          </li>
        </ul> 
      </div>
      <div class="subheading mb-3">Explanation of State Machine
          <div class="resume-item d-flex flex-column flex-md-row">
            <img class="img-fluid mx-auto mb-2 pink" src="img/pink_states.png" alt="">
          </div>
        </div>
        <div class="subheading mb-3">Functions
          <ul>
            <li><p class = "bullet">int speech_to_text() </p>
              <ul>
                <li><p class = "bullet">This function is called when a button is pressed and it immediately turns on the microphone and starts recording data. It then posts the data to the Google speech API which then returns the text of when was said. The code then calls getSeconds() which returns a time in milliseconds if a valid time was received from the google API, otherwise it returns 0.</p>
                </li>
              </ul>
            </li>
            <li><p class = "bullet">void stepCounter() </p>
              <ul>
                <li><p class = "bullet">This function records steps in a global array, and a movement is deemed a “step” when the filtered IMU reading for the y-axis is greater than 1.2. </p>
                </li>
              </ul>
            </li>
            <li><p class = "bullet">void EKG() </p>
              <ul>
                <li><p class = "bullet">This function detects peaks in the signal from the pulse sensor and then records BPMs in a global array, <i>heartrate_values</i>. </p>
                </li>
                <li><p class = "bullet">Read a value from analog pin A7 100 times every second </p>
                </li>
                <li><p class = "bullet">Apply an averaging filter of the last 5000 data points (last 50 seconds of data) </p>
                  <ul>
                    <li><p class = "bullet">update the stored values of the last 500 data points by shifting them down to add the most recent data point with the scaled value from A7 </p>
                    </li>
                    <li><p class = "bullet">Calculate the average of the last 5000 data points </p>
                    </li>
                  </ul>
                </li>
                <li><p class = "bullet">Detect a pulse if two conditions met </p>
                  <ul>
                    <li><p class = "bullet">Has it been 300 ms since the last peak was detected? </p>
                    </li>
                    <li><p class = "bullet">Is the scaled value from A7 greater than the calculated threshold, average*1.3? </p>
                    </li>
                  </ul>
                </li>
                <li><p class = "bullet">Calculating BPM</p>
                  <ul>
                    <li><p class = "bullet">Store number of pulses detected in 5 second intervals for last 6 “5 second intervals” (essentially 30 seconds of data)</p>
                    </li>
                    <li><p class = "bullet">Sum the number of pulses collected in last 6 “5 second intervals” and multiply by 2 </p>
                    </li>
                    <li><p class = "bullet">Store BPM in array heartrate_values, and store a pointer, heartrate_index, to keep track of the location of the last index in heartrate_values that was updated </p>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li><p class = "bullet">void graphEKG() </p>
              <ul>
                <li><p class = "bullet">This function graphs up to the last 25 BPMs (125 seconds of past BPM data) collected, plotting a datapoint every 5 seconds as it is collected.</p>
                </li>
                <li><p class = "bullet">Since we want the graph to be plotting continuously and not jumping every 5 seconds when a reading is collected, we divide each line from a past BPM to current BPM collected into segments that we incrementally draw on the OLED while the next BPM value is being collected.</p>
                </li>
                <li><p class = "bullet">A state machine was used in order to separate different values being plotted.</p>
                </li>
                <div class="resume-item d-flex flex-column flex-md-row">
                  <img class="img-fluid mx-auto mb-2 pink" src="img/ekg_graph.png" alt="">
                </div>
              </ul>
            </li>
            <li><p class = "bullet">Integration of Collecting Data: Setting a flag </p>
              <div class="resume-item d-flex flex-column flex-md-row">
                <img class="img-fluid mx-auto mb-2 machine" src="img/flag.png" alt="">
              </div>
            </li>
            <li><p class = "bullet">Python Posting </p>
              <ul>
                <li><p class = "bullet">We saved the data we posted in a SQL database. We saved the list of the steps data and heart rate data as a string with brackets and commas to break up the data points.</p>
                </li>
                <li><p class = "bullet">In the database we saved the run ID, time at which the run ended, the heart rate data and the steps data.</p>
                </ul>
              </li>
              <li><p class = "bullet">Python Graphing </p>
                <ul>
                  <li><p class = "bullet">With a GET request, we got data from the SQL database of the most recent run.</p>
                  </li>
                  <li><p class = "bullet">Since both BPM and steps per minute data are collected and added to their respective arrays every 5 seconds, we calculated the x axis time values by multiplying the array pointer index by 5.</p>
                  </li>
                  <li><p class = "bullet">To plot the data we collect at the end of the run, we used the bokeh plotting library to create line graphs of heart rate (BPM) and steps/second by time. We used html to put the graph on the server. </p>
                  </li>
                  <li><p class = "bullet">Tokenize and parse are helper functions that convert the string from the database to an array.</p>
                  </li>
                </ul>
              </li>
            </ul> 
          </div>

        </ul> 

      </div>
    </div>
  </div>

</div>
</div>
</section>

<section class="resume-section p-3 p-lg-5 d-flex flex-column" id="interests">
  <div class="my-auto">
    <h2 class="mb-5">Team 17</h2>
    <!-- <p>joe steinmeyer is bae</p> -->
    <!-- <p class="mb-0">did i stutter? </p> -->
    <p> </p>
    <div class="container marketing">

      <!-- Three columns of text below the carousel -->
      <div class="row">
        <div class="col-lg-3">
          <img class="rounded-circle human-pic" src="img/shannen.JPEG" alt="Generic placeholder image" width="140" height="140">
          <div class="subheading mb-3 human-text">Shannen Wu</div>
        </div><!-- /.col-lg-4 -->
        <div class="col-lg-3">
          <img class="rounded-circle human-pic" src="img/dory.jpg" alt="Generic placeholder image" width="140" height="140">
          <div class="subheading mb-3 human-text">Dory Shen</div>       
        </div><!-- /.col-lg-4 -->
        <div class="col-lg-3">
          <img class="rounded-circle human-pic" src="img/kav.jpg" alt="Generic placeholder image" width="140" height="140">
          <div class="subheading mb-3 human-text">Kaveri Nadhamuni</div>
        </div><!-- /.col-lg-4 -->
        <div class="col-lg-3">
          <img class="rounded-circle human-pic" src="img/meg.jpg" alt="Generic placeholder image" width="140" height="140">
          <div class="subheading mb-3 human-text">Meghana Kamineni</div>
        </div><!-- /.col-lg-4 -->
      </div><!-- /.row -->
    </div>
  </section>

  <section class="resume-section p-3 p-lg-5 d-flex flex-column" id="awards">
    <div class="my-auto">
      <h2 class="mb-5">Conclusion
        <p class = "bullet"> This project provides users with a handy device to track their BPMS and steps during their run. This will help the user gauge how intense their run currently is and whether they are slowing down or speeding up. In addition, the server side components enable the user to view comprehensive statistics about their run even after they have finished running. We hope that <i>Beats</i> will make running more interactive and informative for future generations. 
        </p>
        <!-- <span class="text-primary">Conclusion</span> -->
      </h1>
      <div class="subheading mb-5"> FUTURE WORK
        <ul>
          <li><p class = "bullet">Posting data as you are running so the user is able to see the data displayed on the website during your run</p>
          </li>
          <li><p class = "bullet">Option to pause run - by clicking one of the buttons, the user should be able to pause the timer and sensor data collection if they need to take a break. This way, the timer won’t keep going if they stop and the heart rate and step collected data won’t be greatly affected by a user’s inactivity.</p>
          </li>
          <li><p class = "bullet">Calculating the remaining time left of the run based on the initial timer. This could be displayed on another OLED screen which has run analytics such as time elapsed and time remaining, number of breaks and break times.</p>
          </li>
          <li><p class = "bullet">Map of where you run - By integrating <i>Beats</i> with a GPS, we can track and plot where the user is running with a server side map in real time or a path of the run at the end. A further goal with GPS would be to allow the user to plan out a running route or choose from a set of routes based on distance.</p>
          </li>
        </ul>

      </div>
    </div>
  </section>

</div>

<!-- Bootstrap core JavaScript -->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Plugin JavaScript -->
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom scripts for this template -->
<script src="js/resume.min.js"></script>

</body>

</html>
